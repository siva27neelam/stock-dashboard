<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard - TradingView Widgets</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom right, #0f172a, #1e293b);
            min-height: 100vh;
            color: white;
            padding: 16px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(to right, #1e293b, #0f172a);
            padding: 16px 24px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .header-text {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .app-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(13, 148, 136, 0.2);
        }

        .header-text h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .country-switch {
            background: #0f172a;
            border: 2px solid #0d9488;
            border-radius: 8px;
            padding: 4px;
            display: flex;
            gap: 4px;
            box-shadow: 0 0 10px rgba(13, 148, 136, 0.2);
        }

        .country-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .country-btn.active.us,
        .country-btn.active.india {
            background: #0d9488;
            color: white;
            box-shadow: 0 0 10px rgba(13, 148, 136, 0.3);
        }

        .country-btn:not(.active) {
            background: transparent;
            color: #94a3b8;
        }

        .country-btn:not(.active):hover {
            color: white;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .stock-input {
            width: 200px;
            background: #334155;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
        }

        .stock-input:focus {
            outline: 2px solid #2563eb;
        }

        .add-btn {
            background: #2563eb;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
            font-size: 14px;
        }

        .add-btn:hover {
            background: #1d4ed8;
        }

        .refresh-icon-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .refresh-icon-btn:hover {
            color: white;
            background: #334155;
        }

        .error-msg {
            color: #f87171;
            font-size: 14px;
            margin-top: 8px;
        }

        .help-text {
            color: #64748b;
            font-size: 14px;
            margin-top: 8px;
        }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }

        .stock-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            position: relative;
        }

        .stock-card:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.5);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stock-title {
            font-weight: bold;
            font-size: 16px;
        }



        .stock-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .icon-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .icon-btn.delete:hover {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #94a3b8;
            font-size: 18px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 24px;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width:768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stock-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div id="loading" class="loading">Loading your stocks...</div>

    <div id="app" class="container" style="display:none;">
        <div class="header">
            <div class="header-text">
                <img src="logo.png" alt="Logo" class="app-logo">
                <h1>Stock Dashboard</h1>
            </div>
            <div class="header-controls">
                <div class="input-group">
                    <input type="text" id="stockInput" class="stock-input" placeholder="Symbol (e.g. AAPL)">
                    <button class="add-btn" id="addBtn"><i data-lucide="plus"></i> Add</button>
                </div>

                <div class="country-switch">
                    <button class="country-btn active us" data-country="US">
                        <i data-lucide="globe"></i> US
                    </button>
                    <button class="country-btn india" data-country="India">
                        <i data-lucide="globe"></i> India
                    </button>
                </div>

                <button class="refresh-icon-btn" id="refreshAllBtn" title="Refresh All"><i
                        data-lucide="refresh-cw"></i></button>
                <div id="syncStatus" style="color: #94a3b8;"></div>
            </div>
        </div>
        <div id="errorMsg" class="error-msg" style="display:none; margin-bottom: 16px; padding: 0 16px;"></div>

        <div class="stock-grid" id="stockGrid"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
            No stocks tracked for <span id="emptyCountry"></span> yet. Add one above!
        </div>
    </div>

    <script>
        var MASTER_KEY = '$2a$10$ilwfX9jlaVc35Jk7ikMGZOeSw2BPCC1Azu1/QJqWRXWr42DsKDiQa';
        var ACCESS_KEY = '$2a$10$B.MfltIsYbuMbVyKNTp/AOcFRPPHltKzNuA4Wa/SLNxnbIBF5HJaG';
        var BIN_NAME = 'stock-dashboard-data';

        var currentCountry = 'US';
        var stocks = { US: [], India: [] };
        var binId = '695c0606ae596e708fc6f5b9';
        var syncing = false;

        function initIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }

        document.addEventListener('DOMContentLoaded', function () {
            initIcons();
            loadFromJSONBin().then(function () {
                setupEventListeners();
                renderStocks();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                initIcons();
            });
        });

        function setupEventListeners() {
            document.querySelectorAll('.country-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    currentCountry = this.getAttribute('data-country');
                    updateCountryUI();
                    renderStocks();
                });
            });
            document.getElementById('addBtn').addEventListener('click', addStock);
            document.getElementById('stockInput').addEventListener('keypress', e => { if (e.key === 'Enter') addStock(); });
            document.getElementById('refreshAllBtn').addEventListener('click', renderStocks);
        }

        function updateCountryUI() {
            document.querySelectorAll('.country-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.country-btn[data-country="' + currentCountry + '"]').classList.add('active');

            document.getElementById('stockInput').placeholder = currentCountry === 'US'
                ? 'Symbol (e.g. AAPL)'
                : 'Symbol (e.g. TCS, NIFTYBEES)';
        }

        function loadFromJSONBin() {
            return fetch('https://api.jsonbin.io/v3/b/' + binId + '/latest', { headers: { 'X-Access-Key': ACCESS_KEY } })
                .then(r => r.json())
                .then(data => {
                    stocks = data.record;
                    updateSyncStatus(true);
                })
                .catch(err => {
                    console.error(err);
                    // If the bin is empty or new, we might get a specific structure or error, but usually it returns the record.
                    // If it fails, we might want to initialize with empty data but NOT save immediately to avoid overwriting if it was a network error.
                    showError('Failed to load data from cloud');
                });
        }

        function saveToJSONBin() {
            if (!binId) return Promise.resolve();
            syncing = true; updateSyncStatus(false);
            return fetch('https://api.jsonbin.io/v3/b/' + binId, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Access-Key': ACCESS_KEY }, body: JSON.stringify(stocks) })
                .then(() => { syncing = false; updateSyncStatus(true); })
                .catch(err => { console.error(err); showError('Failed to sync data'); syncing = false; });
        }

        function updateSyncStatus(synced) {
            var statusEl = document.getElementById('syncStatus');
            if (syncing) {
                statusEl.innerHTML = '<i data-lucide="refresh-cw" class="spin"></i>';
            } else {
                statusEl.innerHTML = '';
            }
            initIcons();
        }

        function addStock() {
            var input = document.getElementById('stockInput');
            var symbol = input.value.trim().toUpperCase();
            if (!symbol) return;
            hideError();
            // Add to beginning of array (unshift) for most recent first
            stocks[currentCountry].unshift({ symbol: symbol, name: symbol, favorite: false });
            saveToJSONBin().then(() => {
                renderStocks();
                input.value = '';
            });
        }

        function removeStock(symbol) {
            stocks[currentCountry] = stocks[currentCountry].filter(s => s.symbol !== symbol);
            saveToJSONBin().then(renderStocks);

        }

        function toggleFavorite(symbol) {
            var stock = stocks[currentCountry].find(s => s.symbol === symbol);
            if (stock) {
                stock.favorite = !stock.favorite;
                saveToJSONBin().then(renderStocks);
            }
        }

        function renderStocks() {
            var grid = document.getElementById('stockGrid');
            var emptyState = document.getElementById('emptyState');
            var currentStocks = stocks[currentCountry];
            if (currentStocks.length === 0) { grid.innerHTML = ''; emptyState.style.display = 'block'; document.getElementById('emptyCountry').textContent = currentCountry; return; }
            emptyState.style.display = 'none';
            grid.innerHTML = '';
            // Sort: Favorites first, then preserve existing order (which is most recent first due to unshift)
            // We create a shallow copy to sort so we don't mutate the original array order permanently if we don't want to,
            // but actually, for display, we just want to prioritize favorites.
            // If we want "most recent additions" to be first, the array is already in that order (if we use unshift).
            // So we just need to stable sort by favorite.
            var displayStocks = [...currentStocks].sort((a, b) => {
                if (a.favorite === b.favorite) return 0; // Keep original order (recency)
                return a.favorite ? -1 : 1; // Favorites first
            });

            displayStocks.forEach(stock => {
                var card = document.createElement('div'); card.className = 'stock-card';
                var starClass = stock.favorite ? 'fill: #fbbf24; color: #fbbf24;' : '';

                card.innerHTML = `
            <div class="stock-header">
                <div class="stock-title">${stock.name}</div>
                <div class="stock-actions">
                    <button class="icon-btn" onclick="toggleFavorite('${stock.symbol}')" title="Toggle Favorite">
                        <i data-lucide="star" style="width: 16px; height: 16px; ${starClass}"></i>
                    </button>
                    <button class="icon-btn delete" onclick="removeStock('${stock.symbol}')" title="Remove Stock">
                        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
            </div>
            <div id="tv-${stock.symbol}" style="height:320px;"></div>
        `;
                grid.appendChild(card);
                var symbolParam = stock.symbol;
                var timezone = currentCountry === 'India' ? 'Asia/Kolkata' : 'America/New_York';
                new TradingView.widget({
                    container_id: 'tv-' + stock.symbol,
                    width: '100%',
                    height: 320,
                    symbol: symbolParam,
                    interval: 'D',
                    timezone: timezone,
                    theme: 'dark',
                    style: '2',
                    locale: 'en',
                    toolbar_bg: '#1e293b',
                    enable_publishing: false,
                    hide_top_toolbar: false,
                    allow_symbol_change: false,
                    studies: [
                        'MASimple@tv-basicstudies',
                        'RSI@tv-basicstudies',
                        'MACD@tv-basicstudies'
                    ]
                });
            });
            initIcons();
        }

        function showError(msg) { var e = document.getElementById('errorMsg'); e.textContent = msg; e.style.display = 'block'; }
        function hideError() { document.getElementById('errorMsg').style.display = 'none'; }

    </script>
</body>

</html>